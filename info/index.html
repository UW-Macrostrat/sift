<!DOCTYPE html>
<html>
<head>
  <title>Macrostrat Sift - info</title>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Language" content="en">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="../css/styles.min.css" />
  <link rel="stylesheet" href="../css/lib/bootstrap.min.css" />
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <!--<link href="//fonts.googleapis.com/css?family=Maven+Pro&text=macrostrat" rel="stylesheet" type="text/css">-->
  <style>
    html, body {
      overflow: visible;
    }

    .mycontainer {
      height: auto;
      position: relative;
      padding-bottom: 50px;
    }

    .page-title {
      color: #aaa;
      font-size: 1.7em;
      letter-spacing: 2px;
      font-weight: 200;
      text-align: center;
      text-decoration: none;
      padding: 15px;
    }
    .page-title > a {
      color: #aaaaaa;
    }
    .page-title > a:hover {
      text-decoration: none;
    }

    .headerItem.left > a:hover {
      text-decoration: none;
    }

    #map, #waiting {
      width: 100%;
      height: 400px;
    }
    #waiting {
      background-color: rgba(255,255,255,0.5);
      position: absolute;
      display: table;
      z-index: 10000;
      margin-top: -400px;
      visibility: hidden;
    }
    .waiting-container {
      margin: 0 auto;
      text-align: center;
      display: table-cell;
      vertical-align: middle;
      font-size: 60px;
      color: #990000;
    }
    #not-map {
      padding: 20px;
      width: 100%;
    }
    .strat_name {
      border: 1px solid #eee;
      display: inline-block;
      vertical-align: middle;
      padding: 0 2px;
    }

    #primary_strat_name > .strat_name_content > a {
      color: #456C84;
      font-weight: bold;
    }
    .strat_name_content {
      height: 100%;
      width: 100%;
      display: table;
      text-align: center;
      line-height: 12px;
    }
    .strat_name_content > a {
      display: table-cell;
      vertical-align: middle;
      text-decoration: none;
      color: #777;
    }

    .name-hierarchy {
      width: 92%;
      padding-top: 35px;
      max-width: 700px;
      margin: 0 auto;
    }

    .hierarchy-container {
      border: 1px solid #eee;
      cursor: pointer;
    }

    .hierarchy-name {
      font-weight: bold;
      padding: 7px;
    }

    .hierarchy-link {
      text-decoration: none;
      color: #000;
    }
    .hierarchy-link:hover {
      color: #990000;
      text-decoration: none;
    }
    .active-strat-name {
      background-color: rgba(153, 0, 0, 0.3);
      border: 2px solid rgba(153, 0, 0, 0.3);
    }
    .not-active-strat-name {
      background-color: #ffffff;
    }

    .hierarchy-2 {
      margin-left: 20px;
    }
    .hierarchy-3 {
      margin-left: 40px;
    }
    .hierarchy-4 {
      margin-left: 60px;
    }
    .hierarchy-5 {
      margin-left: 80px;
    }

    .column-summary-row {
      text-align: center;
      font-size: 20px;
      border-bottom: 1px solid #eeeeee;
    }

    .column-summary-row > .columns {
      min-height: 100px;
      padding: 25px;
    }
    .column-summary-row > div {
      min-height: 100px;
      padding: 25px;
    }
    .desc {
      font-size: 14px;
      color: #aaa;
      display: block;
    }

    .lithologies {
      font-size: 12px;
    }

    .lithologyChart, .environChart {
      min-height: 300px !important;
    }

    .columns > a {
      color: #000;
      text-decoration: none;
    }
    .column-summary-row > div > a {
      color: #000;
      text-decoration: none;
    }
    #stats {
      width: 95%;
    }

    .section-box {
     /* margin-bottom: 20px;*/

    }
    .section-box > a {
      text-decoration: none;
    }

    .unit-box {
      text-align: center;
      min-height: 24px;
    }

    .ten.columns {
      margin-left: 0;
      min-height: 24px
    }

    .section-container {
      margin-left: 0;
      min-height: 24px;
    }
    .column-div {
      padding: 0 !important;
    }

    .period-names {
      text-align: center;
    }

    .group-link {
      color: #aaaaaa;
    }
    .group-link:hover {
      text-decoration: none;
    }


    .onoffswitch {
        position: relative; width: 106px;
        -webkit-user-select:none; -moz-user-select:none; -ms-user-select: none;
    }
    .onoffswitch-checkbox {
        display: none !important;
    }
    .onoffswitch-label {
        display: block; overflow: hidden; cursor: pointer;
        border: 2px solid #E6DFDF; border-radius: 12px;
    }
    .onoffswitch-inner {
        display: block; width: 200%; margin-left: -100%;
        -moz-transition: margin 0.3s ease-in 0s; -webkit-transition: margin 0.3s ease-in 0s;
        -o-transition: margin 0.3s ease-in 0s; transition: margin 0.3s ease-in 0s;
    }
    .onoffswitch-inner:before, .onoffswitch-inner:after {
        display: block; float: left; width: 50%; height: 30px; padding: 0; line-height: 30px;
        font-size: 13px; color: white; font-family: Trebuchet, Arial, sans-serif; font-weight: bold;
        -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box;
    }
    .onoffswitch-inner:before {
        content: "Columns";
        padding-left: 12px;
        background-color: #AAAAAA; color: #FFFFFF;
    }
    .onoffswitch-inner:after {
        content: "Outcrop";
        padding-right: 12px;
        background-color: #34A7C1; color: #FFFFFF;
        text-align: right;
    }
    .onoffswitch-switch {
        display: block; width: 18px; margin: 6px;
        background: #FFFFFF;
        border: 2px solid #E6DFDF; border-radius: 12px;
        position: absolute; top: 0; bottom: 0; right: 72px;
        -moz-transition: all 0.3s ease-in 0s; -webkit-transition: all 0.3s ease-in 0s;
        -o-transition: all 0.3s ease-in 0s; transition: all 0.3s ease-in 0s; 
    }
    .onoffswitch-checkbox:checked + .onoffswitch-label .onoffswitch-inner {
        margin-left: 0;
    }
    .onoffswitch-checkbox:checked + .onoffswitch-label .onoffswitch-switch {
        right: 0px; 
    }

    @media(max-width: 550px) {
      .column-summary-row > .columns {
        min-height: 70px;
        padding: 15px;
      }
    }
    

  </style>
</head>
<body>

  <div id="header">
    <div class="headerItem left">
      <a href="/"><img src="../img/logo_red.png" class="header-logo"></a>
      <a href="/sift">
        <h3 class="header-title"><i>sift</i></h3>
      </a>
    </div>
    <div class="headerItem right">
      <div class="searchBox typeahead">
        <input class="searcher" type="text" placeholder="Search" data-provide="typeahead">
      </div>
    </div>  
  </div>

  <div class="mycontainer">
    <div class="page-title"></div>
    <div id="map"></div>
    <div id="waiting">
      <div class="waiting-container">
        <i class="fa fa-circle-o-notch fa-spin"></i>
      </div>
    </div>
    <div id="not-map">
      <div id="stats"></div>
      <div class="name-hierarchy"></div>
    </div>
  </div>

  <script id="name-hierarchy-template" type="x-tmpl-mustache">
  <h3>Stratigraphic name hierarchy</h3>
  {{#hierarchy}}
  <a href="/sift/info/?strat_name_id={{strat_name_id}}" class="hierarchy-link">
    <div class="hierarchy-container hierarchy-1 {{active}}">
      <div class="hierarchy-name">{{strat_name}} {{rank}}</div>
      {{#children}}
      <a href="/sift/info/?strat_name_id={{strat_name_id}}" class="hierarchy-link">
        <div class="hierarchy-container hierarchy-2 {{active}}">
          <div class="hierarchy-name">{{strat_name}} {{rank}}</div>
          {{#children}}
          <a href="/sift/info/?strat_name_id={{strat_name_id}}" class="hierarchy-link">
            <div class="hierarchy-container hierarchy-3 {{active}}">
              <div class="hierarchy-name">{{strat_name}} {{rank}}</div>
              {{#children}}
              <a href="/sift/info/?strat_name_id={{strat_name_id}}" class="hierarchy-link">
                <div class="hierarchy-container hierarchy-4 {{active}}">
                  <div class="hierarchy-name">{{strat_name}} {{rank}}</div>
                  {{#children}}
                  <a href="/sift/info/?strat_name_id={{strat_name_id}}" class="hierarchy-link">
                    <div class="hierarchy-container hierarchy-5 {{active}}">
                      <div class="hierarchy-name">{{strat_name}} {{rank}}</div>
                    </div>
                  </a>
                  {{/children}}
                </div>
              </a>
              {{/children}}
            </div>
          </a>
          {{/children}}
        </div>
      </a>
      {{/children}}
    </div>
  </a>
  {{/hierarchy}}
  </script>

  <script id="unit-template" type="x-tmpl-mustache">
    <div class="row column-summary-row">
      <div class="four columns column-name">
        <a href="/sift/info/?col_id={{col_id}}">{{col_name}}</a> <small>(<a class="group-link" href="/sift/info/?col_group_id={{col_group_id}}">{{col_group}}</a>)</small> <span class="desc">column</span>
      </div>
      <div class="four columns">{{b_age}} - {{t_age}} <small>Ma</small> <span class="desc">age</span></div>
      <div class="four columns">{{col_area}} <small>km<sup>2</sup></small><span class="desc">area</span></div>
    </div>
    <div class="row column-summary-row">
      <div class="four columns">{{pbdb_collections}} <span class="desc">PBDB collections</span></div>
      <div class="four columns">{{max_thick}} - {{min_thick}} <small>m</small> <span class="desc">thick</span></div>
    </div>
    <div class="row column-summary-row">
      <div class="six columns"><div class="environChart"></div><span class="desc">environments</span></div>
      <div class="six columns"><div class="lithologyChart"></div><span class="desc">lithologies</span></div>
    </div>
  </script>

  
  <script id="column-template" type="x-tmpl-mustache">
    <div class="row column-summary-row">
      <div class="col-sm-6"><div class="environChart"></div><span class="desc">environments</span></div>
      <div class="col-sm-6"><div class="lithologyChart"></div><span class="desc">lithologies</span></div>
    </div>
    <div class="row column-summary-row">
      <div class="col-sm-4">{{t_sections}} <span class="desc">sections</span></div>
      <div class="col-sm-4">{{t_units}} <span class="desc">units</span></div>
      <!--<div class="col-sm-4">{{pbdb_collections}} <span class="desc">PBDB collections</span></div>-->
      <div class="col-sm-4">{{max_thick}} - {{min_thick}} <small>m</small><span class="desc">thick</span></div>
      
    </div>
    <div class="row column-summary-row">
      <div class="col-sm-4">{{col_area}} <small>km<sup>2</sup></small><span class="desc">area</span></div>
      <div class="col-sm-4">{{b_age}} - {{t_age}} <small>Ma</small> <span class="desc">age</span></div>
      <div class="col-sm-4">{{pbdb_collections}} <span class="desc">PBDB collections</span></div>
    </div>
  </script>

  <script id="column-summary-template" type="x-tmpl-mustache">
    <div class="row column-summary-row">
      <div class="col-sm-3">{{#groups}}<a href="/sift/info/?col_group_id={{col_group_id}}">{{col_group}}</a> <br>{{/groups}}<span class="desc">group(s)</span></div>
      <div class="col-sm-3">{{columns}} <span class="desc">columns</span></div>
      <div class="col-sm-3">{{sections}} <span class="desc">sections</span></div>
      <div class="col-sm-3">{{units}} <span class="desc">units</span></div>
    </div>
    <div class="row column-summary-row">
      <div class="col-sm-6"><div class="lithologyChart"></div><span class="desc">lithologies</span></div>
      <div class="col-sm-6"><div class="environChart"></div><span class="desc">environments</span></div>
    </div>
    <div class="row column-summary-row">
      <div class="col-sm-3">{{area}} <small>km<sup>2</sup></small><span class="desc">area</span></div>
      <div class="col-sm-3">{{b_age}} - {{t_age}} <small>Ma</small> <span class="desc">age</span></div>
      <div class="col-sm-3">{{max_thick}} - {{min_thick}} <small>m</small> <span class="desc">thick</span></div>
      <div class="col-sm-3">{{pbdb_collections}} <span class="desc">PBDB collections</span></div>
    </div>
  </script>



  <script id="group-template" type="x-tmpl-mustache">
    <div class="row column-summary-row">
      <div class="col-sm-4">{{columns}} <span class="desc">columns</span></div>
      <div class="col-sm-4">{{sections.length}} <span class="desc">sections</span></div>
      <div class="col-sm-4">{{units.length}} <span class="desc">units</span></div>
    </div>
    <div class="row column-summary-row">
      <div class="col-sm-6 col-sm-offset-3"><div class="lithologyChart"></div><span class="desc">lithologies</span></div>
    </div>
    <div class="row column-summary-row">
      <div class="col-sm-3">{{area}} <small>km<sup>2</sup></small><span class="desc">area</span></div>
      <div class="col-sm-3">{{b_age}} - {{t_age}} <small>Ma</small> <span class="desc">age</span></div>
      <div class="col-sm-3">{{max_thick}} - {{min_thick}} <small>m</small> <span class="desc">thick</span></div>
      <div class="col-sm-3">{{pbdb_collections}} <span class="desc">PBDB collections</span></div>
    </div>
    
  </script>

  <script id="column-layout-template" type="x-tmpl-mustache">
    {{#periods}}
      <div class="row">
        <div class="col-xs-1 col-xs-offset-2 period-names column-div" style="background-color: {{color}};">
          <div class="period-name">{{abbrev}}</div>
        </div>

        <div class="col-xs-7 column-div section-container">
          {{#sections}}
            <div class="section-box">
              {{#units}}
                <a href="/sift/info/?unit_id={{unit_id}}">
                  <div class="unit-box" style="background-color: rgba({{rgba.r}}, {{rgba.g}}, {{rgba.b}}, {{rgba.alpha}}); color: {{text_color}};">{{strat_name}}</div>
                </a>
              {{/units}}
            </div>
          {{/sections}}
        </div>
      </div>
    {{/periods}}

  </script>


  <script src="../js/libs.js"></script>
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script async src="../js/common.js"></script>

  <script>
  (function() {

    var pallette = {

      "lith_type": {
        carbonate: "#366EA6",
        siliciclastic: "#F9D862",
        evaporite: "#DD98BC",
        organic: "#111111",
        chemical: "#c96566",
        volcanic: "#3D9970",
        plutonic: "#D06CAD",
        metamorphic: "#6D3B22",
        sedimentary: "#D76433",
        igneous: "#BD3239",
        metasedimentary: "#AB6836"
      },

      "environ_type": {
        carbonate: "#366EA6",
        siliciclastic: "#F9D862",
        fluvial: "#33A373",
        lacustrine: "#31909B",
        landscape: "#635A21",
        glacial: "#BFECF3",
        eolian: "#B8794C",
        marine: "#366EA6",
        "non-marine": "#635A21",
        "": "#777777"
      }
    }


    // http://color.hailpixel.com/#366EA6,F9D862,DD98BC,111111,C96566,3D9970,D06CAD,6D3B22,D76433,BD3239,AB6836,
    var lithPallette = {
      carbonate: "#366EA6",
      siliciclastic: "#F9D862",
      evaporite: "#DD98BC",
      organic: "#111111",
      chemical: "#c96566",
      volcanic: "#3D9970",
      plutonic: "#D06CAD",
      metamorphic: "#6D3B22",
      sedimentary: "#D76433",
      igneous: "#BD3239",
      metasedimentary: "#AB6836"
    }
    // http://color.hailpixel.com/#366EA6,F9D862,33A373,31909B,635A21,BFECF3,B8794C,366EA6,635A21,
    var environPallette = {
      carbonate: "#366EA6",
      siliciclastic: "#F9D862",
      fluvial: "#33A373",
      lacustrine: "#31909B",
      landscape: "#635A21",
      glacial: "#BFECF3",
      eolian: "#B8794C",
      marine: "#366EA6",
      "non-marine": "#635A21",
      "": "#777777"
    }

    var apiUrl = (window.location.hostname === "localhost") ? "http://localhost:5000" : window.location.origin;

    /* via http://stackoverflow.com/questions/2901102/how-to-print-a-number-with-commas-as-thousands-separators-in-javascript */
    function addCommas(obj) {
      function commaize(x) {
        x = parseInt(x);
        var parts = x.toString().split(".");
        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        return parts.join(".");
      }

      Object.keys(obj).forEach(function(j) {
        if (typeof(obj[j]) === "number" && j != "id" && j != "col_id" && j != "unit_id" && j != "strat_name_id") {
          obj[j] = commaize(obj[j])
        }
      });

      return obj
      
    }

    /* via http://stackoverflow.com/questions/17885850/how-to-parse-a-string-containing-text-for-a-number-float-in-javascript */
    function findNumberInString(obj){
      var matches = obj.replace(/,/g, '').match(/(\+|-)?((\d+(\.\d+)?)|(\.\d+))/);
      return matches && matches[0] || null;
    }


    /* via https://github.com/amussey/hex-to-rgb.js/blob/master/hex-to-rgb.js */
    function hexToRgb(hex, alpha) {
        var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        var toString = function () {
            if (this.alpha == undefined) {
                return "rgb(" + this.r + ", " + this.g + ", " + this.b + ")";
            }
            if (this.alpha > 1) {
                this.alpha = 1;
            } else if (this.alpha < 0) {
                this.alpha = 0;
            }
            return "rgba(" + this.r + ", " + this.g + ", " + this.b + ", " + this.alpha + ")";
        } 
        if (alpha == undefined) {
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16),
                toString: toString
            } : null;
        }
        if (alpha > 1) {
            alpha = 1;
        } else if (alpha < 0) {
            alpha = 0;
        }
        return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16),
            alpha: alpha,
            toString: toString
        } : null;
    }


    var stratHierarchy = (function() {
      var nameTemplate = $('#name-hierarchy-template').html();
      Mustache.parse(nameTemplate);

      function build(strat_name_id) {
        // Get the entire hierarchy associated with a strat_name_id
        $.getJSON(apiUrl + "/api/v2/defs/strat_names?rule=all&strat_name_id=" + strat_name_id, function(data) {
          if (data.success.data.length < 1) {
            throw "No strat names found";
          } 

          var rankMap = {"SGp": null, "Gp": "sgp", "Fm": "gp", "Mbr": "fm", "Bed": "fm", 1: null, 2: "sgp", 3: "gp", 4: "fm", 5: "fm"};
          var rankMapOrder = {"SGp": 1, "Gp": 2, "Fm": 3, "Mbr": 4, "Bed": 5}

          data.success.data.forEach(function(d) {
            if (d.strat_name_id == strat_name_id) {

              $("#myonoffswitch").change(function() {
                swapMapView(d.strat_name_id);
              });

              $(".page-title").html(d.strat_name + " " + d.rank);
              d.active = "active-strat-name";
            } else {
              d.active = "not-active-strat-name";
            }

            d.children = [];
            d.totalChildren = data.success.data.filter(function(j) {
              if (j[d.rank.toLowerCase() + "_id"] == d.strat_name_id) {
                return j
              }
            }).length - 1;
            d.total = d.totalChildren;
          });

          data.success.data.forEach(function(d) {
            var belongsTo = d[rankMap[d.rank] + "_id"];

            // Need to make sure belongsTo doesn't = 0 when it shouldn't (ex: strat_name_id=9574)
            var previousRank = 1;
            while (belongsTo === 0 && d.strat_name_id != strat_name_id) {
              belongsTo = d[rankMap[rankMapOrder[d.rank] - previousRank] + "_id"];
              previousRank--;
            }

            // Find the one it belongs to and add it
            data.success.data.forEach(function(j) {
              if (j.strat_name_id === belongsTo) {
                j.children.push(d);
              }
            })
          });

          // Find the top of the hierarchy and return it
          var hierarchy = _.max(data.success.data, function(d) { return d.totalChildren });

          console.log(hierarchy);

          var rendered = Mustache.render(nameTemplate, {"hierarchy": hierarchy});
          $(".name-hierarchy").html(rendered);


        });
      }


      return {
        build: build
      }


    })();
      

    var columns = (function() {

      function fetch(type, add, callback) {
        var adjacents = "";
        if (!callback) {
          adjacents = "adjacents=true"
        }

        $.getJSON(apiUrl + "/api/v2/columns?" + adjacents + "&response=long&format=topojson_bare&" + type.join("="), function(data) {
          var colProps = data.objects.output.geometries.map(function(d) { return d.properties }); 

          if (type[0] === "col_group_id" || type[0] === "strat_name_id") {

            var summary = addCommas(
                            columns.summarize(colProps)
                          );

            if (type[0] !== "strat_name_id") {
              $(".page-title").html('<a href="/sift/info/?col_group_id=' + data.objects.output.geometries[0].properties.col_group_id + '">' + data.objects.output.geometries[0].properties.col_group + '</a>');
              $("#stats").html(Mustache.render(templates.group, summary));
            } else {
              $("#stats").html(Mustache.render(templates.columnSummary, summary));
            }
            
            // Draw charts
            drawEnvironChart(summarizeAttr(colProps, "environ_type"))
            drawLithologyChart(summarizeAttr(colProps, "lith_type"));

          } else if (type[0] === "col_id") {
            var target = addCommas(
              data.objects.output.geometries.filter(function(d) {
                if (d.properties.col_id == type[1]) {
                  return d
                }
              })[0].properties
            );

            $("#stats").html(Mustache.render(templates.column, target));

            if (!callback) {
              drawEnvironChart(summarizeAttr(colProps, "environ_type"))
              drawLithologyChart(summarizeAttr(colProps, "lith_type"));
              columns.fetchUnits(type[0], type[1], true);
            }

            $(".page-title").html('<a href="/sift/info/?col_id=' + target.col_id + '">' + target.col_name + '</a> <small>(<a class="group-link" href="/sift/info/?col_group_id=' + target.col_group_id + '">' + target.col_group + '</a> ' + target.group_col_id + ')</small>');
          }

          if (add) {
            addToMap(data);
          } 

          if (callback) {
            callback(data);
          }

        });
      }


      function summarize(columns) {

        return {
          "groups" : _.uniq(columns.map(function(d) {
            return {
              col_group: d.col_group,
              col_group_id: d.col_group_id
            }
          }), function(item, key, a) {
            return item.col_group
          }),
          "columns": columns.length,
          "area": columns.map(function(d) { return d.col_area; }).reduce(function(a, b) { return a + b }, 0),
          "b_age" : _.max(columns, function(d) { return d.b_age; }).b_age,
          "t_age" : _.min(columns, function(d) { return d.t_age; }).t_age,
          "min_thick" : _.min(columns, function(d) { return d.min_thick; }).min_thick,
          "max_thick" : _.max(columns, function(d) { return d.max_thick; }).max_thick,
          "pbdb_occs" : _.reduce(columns.map(function(d) { return d.pbdb_occs; }), function(memo, num) { return memo + num; }, 0),
          "pbdb_collections" : _.reduce(columns.map(function(d) { return d.pbdb_collections; }), function(memo, num) { return memo + num; }, 0),
          "sections" : columns.map(function(d) { return d.t_sections; }).reduce(function(a, b) { return a + b }, 0),
          "units" : columns.map(function(d) { return d.t_units; }).reduce(function(a, b) { return a + b }, 0),
          "lith_types" : _.uniq(_.flatten(columns.map(function(d) { return d.lith_types; }))).join(", "),
          "lith_min_thick" : _.min(columns, function(d) { return d.lith_min_thick; }).lith_min_thick,
          "lith_max_thick" :  _.max(columns, function(d) { return d.lith_max_thick; }).lith_max_thick

        }
      }

      function drawLithologyChart(data) {
        console.log("lithChart", data)
        if (!data.length) {
          data = [{name: 'None', y: 1, color: '#EEEEEE'}];
        }
        $('.lithologyChart').highcharts({
            chart: {
              plotBackgroundColor: null,
              plotBorderWidth: null,
              plotShadow: false
            },
            credits : {
              enabled: false
            },
            title : {
              text : ''
            },
            tooltip: {
              enabled: false
              //pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
            },
            plotOptions: {
              pie: {
                 // allowPointSelect: true,
                 // cursor: 'pointer',
                minSize: 160,
                dataLabels: {
                  enabled: true,
                  format: '<b>{point.name}</b>: {point.percentage:.1f} %',
                  style: {
                      color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                  }
                }
              }
            },
            series: [{
              type: 'pie',
              name: 'Lithology',
              data: data
            }]
        });
      }


      function drawEnvironChart(data) {
        console.log("environChart", data)
        if (!data.length) {
          data = [{name: 'None', y: 1, color: '#EEEEEE'}];
        }

        $('.environChart').highcharts({
            chart: {
              plotBackgroundColor: null,
              plotBorderWidth: null,
              plotShadow: false
            },
            credits : {
              enabled: false
            },
            title : {
              text : ''
            },
            tooltip: {
              enabled: false
              //pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
            },
            plotOptions: {
              pie: {
                 // allowPointSelect: true,
                 // cursor: 'pointer',
                minSize: 160,
                dataLabels: {
                  enabled: true,
                  format: '<b>{point.name}</b>: {point.percentage:.1f} %',
                  style: {
                      color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black'
                  }
                }
              }
            },
            series: [{
              type: 'pie',
              name: 'Lithology',
              data: data
            }]
        });
      }


      function drawColumn(data) {
        var column = {"Quaternary":{"name":"Quaternary","abbrev":"Q","color":"#F9F97F","sections":{}},"Neogene":{"name":"Neogene","abbrev":"Ng","color":"#FFE619","sections":{}},"Paleogene":{"name":"Paleogene","abbrev":"Pg","color":"#FD9A52","sections":{}},"Cretaceous":{"name":"Cretaceous","abbrev":"K","color":"#7FC64E","sections":{}},"Jurassic":{"name":"Jurassic","abbrev":"J","color":"#34B2C9","sections":{}},"Triassic":{"name":"Triassic","abbrev":"Tr","color":"#812b92","sections":{}},"Permian":{"name":"Permian","abbrev":"P","color":"#F04028","sections":{}},"Carboniferous":{"name":"Carboniferous","abbrev":"C","color":"#67A599","sections":{}},"Devonian":{"name":"Devonian","abbrev":"D","color":"#CB8C37","sections":{}},"Silurian":{"name":"Silurian","abbrev":"S","color":"#B3E1B6","sections":{}},"Ordovician":{"name":"Ordovician","abbrev":"O","color":"#009270","sections":{}},"Cambrian":{"name":"Cambrian","abbrev":"Cm","color":"#7FA056","sections":{}},"PreCambrian":{"name":"PreCambrian","abbrev":"PCm","color":"#F04370","sections":{}}};

        console.log(data)
        for (var i = 0; i < data.length; i++) {
          // Get the rgb value of the hex color
          data[i].rgba = hexToRgb(data[i].color.replace("#", ""), 0.7);

          // Remove plutonic and metamorphic for now
          if (data[i].lith_type.indexOf("plutonic") > -1 || data[i].lith_type.indexOf("metamorphic") > -1) {
            continue;
          }


          // If there is no period or it's an unknown one, add it to PreCambrian
          if (!column[data[i].period]) {
            // If this time interval already has this section_id
            if (column["PreCambrian"].sections[data[i].section_id]) {
              column["PreCambrian"].sections[data[i].section_id].units.push(data[i]);
            } 
            // If this time interval doesn't have this section_id, add it
            else {
              column["PreCambrian"].sections[data[i].section_id] = {
                "id": data[i].section_id,
                "units": [data[i]]
              }
            }
          } 
          // If both this time interval exist and the time interval has this seciton, add the unit
          else if (column[data[i].period].sections[data[i].section_id]) {
            column[data[i].period].sections[data[i].section_id].units.push(data[i]);
          } 
          // Otherwise, add it as a new section in the time interval
          else {
            column[data[i].period].sections[data[i].section_id] = {
              "id": data[i].section_id,
              "units": [data[i]]
            }
          }
        }

        var newColumn = Object.keys(column).map(function(d) { 
          return column[d]; 
        });

        newColumn.forEach(function(d) {
          d.sections = Object.keys(d.sections).map(function(j) {
            return d.sections[j];
          });
        });

        newColumn = newColumn.filter(function(d) {
          if (d.sections.length > 0) {
            return d;
          }
        });
        
        // Draw the column
        $(".name-hierarchy").html(Mustache.render(templates.columnLayout, {"periods": newColumn }));

        // Adjust, adjust
        $(".period-names").css("height", function() {
          return $(this).next().height();
        });
        $(".period-names").css("line-height", function() {
          return $(this).next().height() + "px";
        });

      }

      function summarizeAttr(data, attr) {
        var types = _.groupBy(_.flatten(data.map(function(d) { return d[attr] })), "type"),
            all = [];

        Object.keys(types).forEach(function(d) {
          var prop = types[d].map(function(d) { return d.prop }).reduce(function(a, b) { return a + b }, 0);
          all.push({
            name: d, 
            y: prop/data.length, 
            color: pallette[attr][d] 
          });
        });

        return all;
        
      }


      function fetchUnits(type, ids, drawStratColumn) {

        $.getJSON(apiUrl + "/api/v2/units?response=long&" + type + "=" + ids, function(data) {
          data = data.success.data;
        
          if (type === "col_id") {
            drawColumn(data);
          }

        });
      }


      return {
         fetch: fetch,
         summarize: summarize,
         fetchUnits: fetchUnits,
         summarizeAttr: summarizeAttr,
         drawLithologyChart: drawLithologyChart,
         drawEnvironChart: drawEnvironChart
      }
    })();

      

    function addToMap(data) {
      columnLayer = L.geoJson(topojson.feature(data, data.objects.output), {
        style: function(feature) {
          if (type[0] === "col_id" && feature.properties.col_id == type[1]) {
            return {
              color: "#990000",
              fillOpacity: 0.6,
              opacity: 0.8,
              weight: 1
            };
          } else {
            return {
              color: "#777777",
              fillOpacity: 0.4,
              opacity: 0.8,
              weight: 1
            };
          }
            
        },
        onEachFeature: function (feature, layer) {
          layer.on("click", function(d) { 
            window.location = "/sift/info/?col_id=" + d.target.feature.properties.col_id; 
          });
        }
      }).addTo(map);

      map.fitBounds(columnLayer.getBounds());
    }
      

    function drawMap(type) {
      map = L.map("map", {
        minZoom: 4,
        maxZoom: 10,
        zoomControl: false,
        scrollWheelZoom: false,
        keyboard: false,
        dragging: false,
        touchZoom: false,
        doubleClickZoom: false,
        boxZoom: false
      });

      // Add our basemap
      
      dark = L.tileLayer("https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png", {
        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>'
      });

      tiles = L.tileLayer("https://{s}.tiles.mapbox.com/v3/jczaplewski.j751k57j/{z}/{x}/{y}.png", {
        attribution: "<a href='https://www.mapbox.com/about/maps/' target='_blank'>&copy; Mapbox &copy; OpenStreetMap</a>"
      }).addTo(map);


      if (type === "strat_name_id") {
        var toggle = L.Control.extend({
          options: {
            position: 'bottomleft'
          },
          onAdd: function (map) {
              var container = L.DomUtil.create('div', 'map-toggle');

              container.innerHTML = '<div class="onoffswitch"><input type="checkbox" name="onoffswitch" class="onoffswitch-checkbox" id="myonoffswitch" checked><label class="onoffswitch-label" for="myonoffswitch"><span class="onoffswitch-inner"></span><span class="onoffswitch-switch"></span></label></div>'
              return container;
          }
        });

        map.addControl(new toggle());
      }

    }

    function swapMapView(strat_name_id) {
      $("#waiting").css("visibility", "visible");
      if (typeof(gmusGeology) == "undefined" ) {
        $.getJSON(apiUrl + "/api/v2/geologic_units/gmus?format=topojson_bare&strat_name_id=" + strat_name_id, function(data) {
          gmusGeology = L.geoJson(topojson.feature(data, data.objects.output), {
            style: function(feature) {
              return {
                color: feature.properties.interval_color,
                fillOpacity: 0.8,
                opacity: 0.8,
                weight: 1
              };
            }
          });

          swap();
        });
      } else {
        swap();
      }

      function swap() {
        if (map.hasLayer(tiles)) {
          map.removeLayer(tiles);
          map.addLayer(dark);
          map.removeLayer(columnLayer);
          map.addLayer(gmusGeology);
        } else {
          map.removeLayer(dark);
          map.addLayer(tiles);
          map.addLayer(columnLayer);
          map.removeLayer(gmusGeology);
        }
        $("#waiting").css("visibility", "hidden");
      }
        
    }

    function getStratNameId(unit_id) {
      $.getJSON(apiUrl + "/api/v2/units?response=long&unit_id=" + unit_id, function(data) {
        if (data.success.data.length > 0) {

          var unit = data.success.data[0],
              liths = columns.summarizeAttr(data.success.data, "lith_type"),
              environs = [],
              eType = (unit.environ_type.length > 0) ? "environ_type" : "environ_class";
              
          unit[eType].forEach(function(d) {
            environs.push({name: d, y: 100/unit[eType].length, color: environPallette[d]});
          });

          stratHierarchy.build(unit.strat_name_id);

          var column = columns.fetch(["col_id", unit.col_id], true, function(data) {
            unit.col_group = data.objects.output.geometries[0].properties.col_group;
            unit.col_group_id = data.objects.output.geometries[0].properties.col_group_id;
            unit.col_name = data.objects.output.geometries[0].properties.col_name;

            unit = addCommas(unit);

            $("#stats").html(Mustache.render(templates.unit, unit));

            $(".page-title").html("<a href='/sift/info/?unit_id=" + unit.unit_id + "'>" + unit.strat_name + " <small>(" + unit.unit_id + ")</small></a>");

            columns.drawLithologyChart(liths);
            columns.drawEnvironChart(environs);
          });
        }
      });
    }

    function getData() {

      if (type[0] === "strat_name_like" || type[0] === "strat_name" || type[0] === "strat_name_id") {
        // Get strat_name hierarchy
        stratHierarchy.build(type[1]);
        columns.fetch(type, true);
      
      } else if (type[0] === "unit_id") {
        // Find unit strat name then get hierarchy
        getStratNameId(type[1]);
        
      } else if (type[0] === "col_id" || type[0] === "col_group_id") {
        // Draw strat column
        columns.fetch(type, true);
      }

    }
    
    var templates = {
      column: $('#column-template').html(),
      columnSummary: $('#column-summary-template').html(),
      columnLayout: $('#column-layout-template').html(),
      unit: $('#unit-template').html(),
      group: $('#group-template').html()
    }

    // Get the templates ready to use
    Object.keys(templates).forEach(function(d) {
      Mustache.parse(templates[d]);
    });


    var queryParams = ["strat_name_like", "strat_name", "strat_name_id", "col_id", "col_group_id", "col_group", "interval", "interval_id", "lith", "lith_type", "lith_class", "age", "unit_id"];

    var type = window.location.search.replace("/", "").replace("?", "").split("=");

    if (queryParams.indexOf(type[0]) > -1) {
      console.log("valid query");
      getData();
      drawMap(type[0]);
    } else {
      console.log("invalid query");
    }
  })()

  </script>
</body>
</html>
